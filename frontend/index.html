<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ongao's Poker Lab ğŸš€</title>

<!-- ç°ä»£æ„Ÿå­—ä½“ -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..900&display=swap" rel="stylesheet">

<!-- ä¸»é¢˜æ ·å¼ï¼ˆçº¯é™æ€ï¼šä¸å†ç”¨ url_forï¼‰ -->
<link rel="stylesheet" href="./style.css">

<style>
  /* è½»é‡æ ·å¼å¢å¼ºï¼šé€‚é…ä½ ç°æœ‰çš„ style.cssï¼Œä¸ä¼šå†²çª */
  :root{--grad1:#60a5fa;--grad2:#a78bfa}
  body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container { max-width: 960px; margin: 0 auto; padding: 28px 16px; }
  h1 { margin: 0 0 6px 0; }
  .sub { color: #6b7280; margin: 0 0 16px 0; }
  .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; margin: 12px 0; }
  .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .row > * { flex: 1 1 180px; }
  .input-mini { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
  .btn { padding: 10px 14px; border: 1px solid #d1d5db; background: #111827; color: #fff; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn.secondary { background: #fff; color: #111827; }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  .help { font-size: 12px; color: #6b7280; }
  .output { white-space: pre-wrap; background: #0b1020; color: #e5e7eb; padding: 12px; border-radius: 10px; min-height: 48px; }
  .bar-wrap { background: #f3f4f6; border-radius: 12px; overflow: hidden; height: 14px; }
  .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--grad1), var(--grad2)); transition: width .4s ease; }
  .pair { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .stack { display: grid; gap: 8px; }
  .muted { color: #6b7280; }
  .danger { color: #b91c1c; }
  .ok { color: #065f46; }
  .loading { animation: pulse 1.1s infinite ease-in-out; }
  @keyframes pulse { 0%{opacity:.55} 50%{opacity:1} 100%{opacity:.55} }
  .inline { display: inline-flex; gap: 8px; align-items: center; }
  .pill { font-size: 12px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 999px; }
  .kvs { display: grid; grid-template-columns: 160px 1fr; gap: 8px; }
  code.inline { background: #f3f4f6; padding:2px 6px; border-radius:6px;}

  /* è¾“å…¥å³æ—¶æ ¡éªŒå¯è§†åŒ– */
  .is-invalid { border-color:#dc3545 !important; box-shadow:0 0 0 .2rem rgba(220,53,69,.12) !important; }
  .help-row { display:flex; gap:10px; align-items:baseline; flex-wrap: wrap; margin-top:4px; }
  .help-preview { color:#6b7280; font-size:12px; }
  .help-error { color:#b91c1c; font-size:12px; }
  #dup-alert { display:none }

  /* â€”â€” æ–°å¢ï¼šSSE å®æ—¶è¿›åº¦é¢æ¿ â€”â€” */
  .progress-card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin:12px 0;display:none}
  .progress-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .progress-sub{color:#6b7280}
  .bar-wrap.x{height:14px}
  .bar.x{height:100%;width:0%;background:linear-gradient(90deg,var(--grad1),var(--grad2));transition:width .15s ease}
</style>
</head>

<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand">Ongao's Poker Lab</div>
      <button id="themeBtn" class="theme-toggle" type="button">â˜¾/â˜€ï¸</button>
    </div>
  </header>

  <main class="container">
    <h1>Ongao's Poker Lab ğŸš€</h1>
    <p class="sub">è¾“å…¥æ‰‹ç‰Œä¸å…¬å…±ç‰Œï¼Œä¸€é”®è·å–èƒœç‡ï¼Œå¹¶åŸºäº Pot Odds ç»™å‡ºä¸‹æ³¨å»ºè®®ï¼›è‹¥åç«¯æä¾› LLM æ–‡æ¡ˆï¼Œåˆ™æ˜¾ç¤ºæ›´è¯¦ç»†çš„ç­–ç•¥ã€‚</p>

    <!-- è¾“å…¥åŒº -->
    <section class="card">
      <h2>è¾“å…¥ç‰Œé¢</h2>
      <div class="row">
        <div class="stack">
          <label>æ‰‹ç‰Œï¼ˆ2 å¼ ï¼Œæ ¼å¼å¦‚ <code class="inline">Ah</code>ã€<code class="inline">Kd</code>ï¼‰</label>
          <div class="pair">
            <input id="hole1" class="input-mini" maxlength="2" placeholder="å¦‚ Ah">
            <input id="hole2" class="input-mini" maxlength="2" placeholder="å¦‚ Kd">
          </div>
          <!-- æ‰‹ç‰Œé¢„è§ˆ/é”™è¯¯ -->
          <div class="help-row">
            <div id="hero_preview" class="help-preview"></div>
            <div id="hero_error" class="help-error"></div>
          </div>
        </div>

        <div class="stack" style="flex: 2 1 360px;">
          <label>å…¬å…±ç‰Œï¼ˆ0â€“5 å¼ ï¼Œä»»æ„é˜¶æ®µè¾“å…¥å³å¯ï¼‰</label>
          <div class="row">
            <input id="b1" class="input-mini" maxlength="2" placeholder="ç¿»ç‰Œ1">
            <input id="b2" class="input-mini" maxlength="2" placeholder="ç¿»ç‰Œ2">
            <input id="b3" class="input-mini" maxlength="2" placeholder="ç¿»ç‰Œ3">
            <input id="b4" class="input-mini" maxlength="2" placeholder="è½¬ç‰Œ">
            <input id="b5" class="input-mini" maxlength="2" placeholder="æ²³ç‰Œ">
          </div>
          <!-- å…¬å…±ç‰Œé¢„è§ˆ/é”™è¯¯ -->
          <div class="help-row">
            <div id="board_preview" class="help-preview"></div>
            <div id="board_error" class="help-error"></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="stack">
          <label>å½©æ± å¤§å°ï¼ˆå¯é€‰ï¼Œå•ä½åŒä¸‹æ³¨ï¼‰</label>
          <input id="pot" class="input-mini" type="number" min="0" step="0.01" placeholder="å¦‚ 10">
        </div>
        <div class="stack">
          <label>ä½ éœ€è¦è·Ÿæ³¨çš„é‡‘é¢ï¼ˆå¯é€‰ï¼‰</label>
          <input id="call" class="input-mini" type="number" min="0" step="0.01" placeholder="å¦‚ 3">
        </div>
        <div class="stack">
          <label>&nbsp;</label>
          <div class="inline">
            <button id="btn-run" class="btn" type="button">è®¡ç®—èƒœç‡</button>
            <button id="btn-reset" class="btn secondary" type="button">é‡ç½®</button>
            <button id="btn-sample" class="btn secondary" type="button">ç¤ºä¾‹å¡«å……</button>
          </div>
        </div>
      </div>
      <div id="dup-alert" class="alert alert-danger mt-2"></div>
      <p class="help">ç‰Œé¢æ ¼å¼ï¼š<code class="inline">2-9,T,J,Q,K,A</code> + <code class="inline">s/h/d/c</code>ï¼ˆâ™ /â™¥/â™¦/â™£ï¼‰ã€‚ä¾‹å¦‚ï¼š<code class="inline">As</code>ã€<code class="inline">Th</code>ã€<code class="inline">7d</code>ã€<code class="inline">9c</code>ã€‚</p>
    </section>

    <!-- â€”â€” æ–°å¢ï¼šå®æ—¶è¿›åº¦ï¼ˆSSEï¼‰ â€”â€” -->
    <section id="progressPanel" class="progress-card">
      <div class="progress-title">
        <div><b id="stageText">å‡†å¤‡ä¸­â€¦</b></div>
        <div class="progress-sub"><span id="etaText"></span></div>
      </div>
      <div class="bar-wrap x">
        <div id="bar" class="bar x"></div>
      </div>
      <div class="progress-sub" style="margin-top:6px;">
        <span id="pctText">0%</span>
        <span id="streetText" class="ms-3"></span>
      </div>
    </section>

    <!-- ç»“æœåŒºï¼šèƒœç‡ + æ¡å½¢å›¾ -->
    <section class="card">
      <h2>èƒœç‡ï¼ˆEquityï¼‰</h2>
      <div class="kvs">
        <div class="muted">æˆ‘æ–¹è·èƒœæ¦‚ç‡</div>
        <div><strong id="equity-text">â€”</strong></div>
      </div>
      <div class="bar-wrap" style="margin:10px 0;">
        <div id="equity-bar" class="bar"></div>
      </div>
      <div class="kvs">
        <div class="muted">å¹³å±€æ¦‚ç‡</div><div id="tie-text">â€”</div>
        <div class="muted">å¤±è´¥æ¦‚ç‡</div><div id="lose-text">â€”</div>
      </div>
    </section>

    <!-- ç­–ç•¥å»ºè®®ï¼ˆLLM æˆ–å…œåº•è§„åˆ™ï¼‰ -->
    <section class="card">
      <h2>ç­–ç•¥å»ºè®®</h2>
      <div class="kvs" style="margin-bottom:8px;">
        <div class="muted">Pot Oddsï¼ˆè‡ªåŠ¨ç®—ï¼‰</div>
        <div id="odds-text">â€”</div>
      </div>
      <div id="advice" class="output">// è¿™é‡Œå°†æ˜¾ç¤ºæ¥è‡ªåç«¯çš„ LLM å»ºè®®ï¼›å¦‚æ— ï¼Œåˆ™æ ¹æ® equity ä¸ pot odds ç»™å‡ºå…œåº•å»ºè®®ã€‚</div>
      <div class="help" style="margin-top:8px">
        å…œåº•è§„åˆ™ï¼šå½“ <code class="inline">equity â‰¥ pot_odds</code> å€¼å¾—è·Ÿæ³¨ï¼›ä¼˜åŠ¿è¾ƒå¤§ä¸”å¯¹æ‰‹å¼ƒç‰Œç‡å¯è§‚æ—¶å¯åŠ æ³¨ï¼ˆå»ºè®®ä¸‹æ³¨é‡ï¼šå½©æ± çš„ 40%â€“70%ï¼‰ã€‚
      </div>
    </section>

    <footer class="muted" style="margin-top:16px;">
      <small>åç«¯ API é€šè¿‡ <code>window.API_BASE</code> æŒ‡å®šï¼›è®¡ç®—æµç¨‹ï¼š<code>POST /start</code> â†’ <code>EventSource /stream/&lt;task_id&gt;</code>ã€‚</small>
    </footer>
  </main>

  <!-- é…ç½®åç«¯åŸŸåï¼ˆå¿…é¡»åœ¨ app.js å‰åŠ è½½ï¼‰ -->
  <script src="./config.js"></script>

  <!-- ä½ çš„ä¸»é€»è¾‘ï¼ˆä¼šä½¿ç”¨ window.API_BASE å»è¯·æ±‚ /start ä¸ /streamï¼‰ -->
  <script src="./app.js" defer></script>

  <!-- ä¸»é¢˜åˆ‡æ¢ï¼ˆæ”¾åœ¨æŒ‰é’®ä¹‹åæŒ‚è½½ï¼‰ -->
  <script>
    (function(){
      const html = document.documentElement;
      const btn = document.getElementById('themeBtn');
      const set = m => { html.classList.toggle('light', m==='light'); localStorage.setItem('theme', m); }
      const current = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      set(current);
      btn && (btn.onclick = () => set(html.classList.contains('light') ? 'dark' : 'light'));
    })();
  </script>

  <!-- å‰ç«¯å®æ—¶æ ¡éªŒä¸è§„èŒƒåŒ–ï¼ˆåŸæœ‰è„šæœ¬ä¿ç•™ï¼‰ -->
  <script>
  // â€”â€” å¤šè¯­è¨€ç‰Œé¢è§„èŒƒåŒ–ï¼ˆé€‚é…ä¸¤å­—ç¬¦è¾“å…¥ï¼šå¦‚ Ahã€Aâ™ ã€thã€7D ç­‰ï¼‰ â€”â€”
  const SUIT_MAP = new Map([
    ['s','s'],['â™ ','s'],['é»‘æ¡ƒ','s'],['é»‘','s'],
    ['h','h'],['â™¥','h'],['çº¢æ¡ƒ','h'],['çº¢','h'],
    ['d','d'],['â™¦','d'],['æ–¹ç‰‡','d'],['æ–¹å—','d'],['æ–¹','d'],
    ['c','c'],['â™£','c'],['æ¢…èŠ±','c'],['æ¢…','c']
  ]);
  const RANK_MAP = new Map([
    ['A','A'],['a','A'],['K','K'],['k','K'],['Q','Q'],['q','Q'],['J','J'],['j','J'],
    ['T','T'],['t','T'],['10','T'],
    ['9','9'],['8','8'],['7','7'],['6','6'],['5','5'],['4','4'],['3','3'],['2','2']
  ]);

  const ids = ['hole1','hole2','b1','b2','b3','b4','b5'];
  const els = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));

  const normSuitSymbols = s => s.replace(/â™ /g,'s').replace(/â™¥/g,'h').replace(/â™¦/g,'d').replace(/â™£/g,'c').replace(/\s+/g,'');

  function normOne(tok){
    if(!tok) throw new Error("ç©ºç‰Œé¢");
    let t = normSuitSymbols(tok.trim());
    let m = t.match(/^(A|K|Q|J|T|[2-9])(s|h|d|c)$/i);
    if(m){
      const r = (RANK_MAP.get(m[1]) || m[1].toUpperCase());
      const s = (m[2]||'').toLowerCase();
      if(r && 'shdc'.includes(s)) return r + s;
    }
    let m2 = t.match(/^(A|K|Q|J|T|[2-9])(é»‘|çº¢|æ–¹|æ¢…)$/i);
    if(m2){
      const r = (RANK_MAP.get(m2[1]) || m2[1].toUpperCase());
      const s = new Map([['é»‘','s'],['çº¢','h'],['æ–¹','d'],['æ¢…','c']]).get(m2[2]);
      if(r && s) return r + s;
    }
    let m3 = tok.trim().match(/^(A|K|Q|J|T|[2-9])\s*(â™ |â™¥|â™¦|â™£)$/i);
    if(m3){
      const r = (RANK_MAP.get(m3[1]) || m3[1].toUpperCase());
      const s = new Map([['â™ ','s'],['â™¥','h'],['â™¦','d'],['â™£','c']]).get(m3[2]);
      if(r && s) return r + s;
    }
    throw new Error(`æ— æ³•è¯†åˆ«ï¼š${tok}`);
  }

  function readAll(){
    ids.forEach(id => els[id] && els[id].classList.remove('is-invalid'));
    document.getElementById('hero_error').textContent = '';
    document.getElementById('board_error').textContent = '';
    document.getElementById('dup-alert').style.display = 'none';
    document.getElementById('dup-alert').textContent = '';

    const get = id => (els[id]?.value || '').trim();
    const errors = [];
    const heroRaw = [get('hole1'), get('hole2')].filter(Boolean);
    const boardRaw = [get('b1'),get('b2'),get('b3'),get('b4'),get('b5')].filter(Boolean);

    if(heroRaw.length !== 2){
      errors.push(`æ‰‹ç‰Œéœ€ 2 å¼ ï¼Œå½“å‰ ${heroRaw.length} å¼ `);
      els.hole1.classList.add('is-invalid');
      els.hole2.classList.add('is-invalid');
    }

    const heroArr = [];
    const boardArr = [];
    for(const [i, v] of heroRaw.entries()){
      try { heroArr.push(normOne(v)); }
      catch(e){ errors.push(`æ‰‹ç‰Œ${i+1}ï¼š${e.message}`); (i===0?els.hole1:els.hole2).classList.add('is-invalid'); }
    }
    const bid = ['b1','b2','b3','b4','b5'];
    boardRaw.forEach((v, i) => {
      try { boardArr.push(normOne(v)); }
      catch(e){ errors.push(`å…¬å…±ç‰Œ${i+1}ï¼š${e.message}`); els[bid[i]].classList.add('is-invalid'); }
    });

    if(new Set(heroArr).size !== heroArr.length){
      errors.push('æ‰‹ç‰Œå­˜åœ¨é‡å¤');
      els.hole1.classList.add('is-invalid');
      els.hole2.classList.add('is-invalid');
    }
    if(new Set(boardArr).size !== boardArr.length){
      errors.push('å…¬å…±ç‰Œå­˜åœ¨é‡å¤');
      bid.forEach((id, i)=> boardRaw[i] && els[id].classList.add('is-invalid'));
    }

    const all = [...heroArr, ...boardArr];
    const seen = new Map(), dup = new Set();
    all.forEach(c => { if(seen.has(c)) dup.add(c); else seen.set(c, true); });
    if(dup.size){
      const dupMsg = `è·¨å­—æ®µé‡å¤ï¼š${[...dup].join(' ')}`;
      const dupBox = document.getElementById('dup-alert');
      dupBox.style.display = 'block';
      dupBox.textContent = dupMsg;

      const markIfDup = (el, val) => { try { if(val && dup.has(normOne(val))) el.classList.add('is-invalid'); } catch(_){} };
      markIfDup(els.hole1, get('hole1'));
      markIfDup(els.hole2, get('hole2'));
      bid.forEach(id => markIfDup(els[id], get(id)));
    }

    document.getElementById('hero_preview').textContent  = heroArr.length ? `è§„èŒƒåŒ–ï¼š${heroArr.join(' ')}` : '';
    document.getElementById('board_preview').textContent = boardArr.length ? `è§„èŒƒåŒ–ï¼š${boardArr.join(' ')}` : '';
    const heroErrs  = errors.filter(x => x.startsWith('æ‰‹ç‰Œ') || x.includes('æ‰‹ç‰Œå­˜åœ¨é‡å¤') || x.includes('éœ€ 2 å¼ '));
    const boardErrs = errors.filter(x => x.startsWith('å…¬å…±ç‰Œ') || x.includes('å…¬å…±ç‰Œå­˜åœ¨é‡å¤'));
    document.getElementById('hero_error').textContent  = heroErrs.join('ï¼›');
    document.getElementById('board_error').textContent = boardErrs.join('ï¼›');

    return { heroArr, boardArr, errors, duplicates: dup };
  }

  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', readAll);
    el.addEventListener('blur', readAll);
  });
  readAll();

  const btnRun = document.getElementById('btn-run');
  if(btnRun){
    btnRun.addEventListener('click', (e)=>{
      const { errors, duplicates, heroArr, boardArr } = readAll();
      if(errors.length || duplicates.size){
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      // å›å¡«è§„èŒƒåŒ–å€¼ï¼Œä¿è¯åç«¯æ”¶åˆ°æ ‡å‡†æ ¼å¼
      const setVal = (id, v) => { const el=document.getElementById(id); if(el) el.value = v || ''; };
      setVal('hole1', heroArr[0] || '');
      setVal('hole2', heroArr[1] || '');
      const b = ['b1','b2','b3','b4','b5'];
      boardArr.forEach((v,i)=> setVal(b[i], v));
      // çœŸæ­£çš„è¯·æ±‚ä¸ SSE è®¢é˜…åœ¨ app.js ä¸­æ‰§è¡Œ
      window.__RUN_SIM__ && window.__RUN_SIM__();
    }, true);
  }

  const btnSample = document.getElementById('btn-sample');
  const btnReset  = document.getElementById('btn-reset');
  if(btnSample){ btnSample.addEventListener('click', ()=> setTimeout(readAll, 0)); }
  if(btnReset){  btnReset.addEventListener('click',  ()=> {
    ['hole1','hole2','b1','b2','b3','b4','b5','pot','call'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value='' })
    setTimeout(readAll, 0);
  }); }
  </script>
</body>
</html>
