<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ongao's Poker Lab 🚀</title>

<!-- 现代感字体 -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..900&display=swap" rel="stylesheet">

<!-- 主题样式（纯静态：不再用 url_for） -->
<link rel="stylesheet" href="./style.css">

<style>
  :root{--grad1:#60a5fa;--grad2:#a78bfa}
  body{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container { max-width: 960px; margin: 0 auto; padding: 28px 16px; }
  h1 { margin: 0 0 6px 0; }
  .sub { color: #6b7280; margin: 0 0 16px 0; }
  .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; margin: 12px 0; }
  .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .row > * { flex: 1 1 180px; }
  .input-mini { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
  .btn { padding: 10px 14px; border: 1px solid #d1d5db; background: #111827; color: #fff; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn.secondary { background: #fff; color: #111827; }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  .help { font-size: 12px; color: #6b7280; }
  .output { white-space: pre-wrap; background: #0b1020; color: #e5e7eb; padding: 12px; border-radius: 10px; min-height: 48px; }
  .bar-wrap { background: #f3f4f6; border-radius: 12px; overflow: hidden; height: 14px; }
  .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--grad1), var(--grad2)); transition: width .4s ease; }
  .pair { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .stack { display: grid; gap: 8px; }
  .muted { color: #6b7280; }
  .danger { color: #b91c1c; }
  .ok { color: #065f46; }
  .loading { animation: pulse 1.1s infinite ease-in-out; }
  @keyframes pulse { 0%{opacity:.55} 50%{opacity:1} 100%{opacity:.55} }
  .inline { display: inline-flex; gap: 8px; align-items: center; }
  .pill { font-size: 12px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 999px; }
  .kvs { display: grid; grid-template-columns: 160px 1fr; gap: 8px; }
  code.inline { background: #f3f4f6; padding:2px 6px; border-radius:6px;}

  .is-invalid { border-color:#dc3545 !important; box-shadow:0 0 0 .2rem rgba(220,53,69,.12) !important; }
  .help-row { display:flex; gap:10px; align-items:baseline; flex-wrap: wrap; margin-top:4px; }
  .help-preview { color:#6b7280; font-size:12px; }
  .help-error { color:#b91c1c; font-size:12px; }
  #dup-alert { display:none }

  .progress-card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin:12px 0;display:none}
  .progress-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .progress-sub{color:#6b7280}
  .bar-wrap.x{height:14px}
  .bar.x{height:100%;width:0%;background:linear-gradient(90deg,var(--grad1),var(--grad2));transition:width .15s ease}

  /* 顶部告警条（API_BASE 未设置时显示） */
  .top-alert{display:none;background:#fee2e2;color:#991b1b;padding:8px 12px;text-align:center}
</style>
</head>

<body>
  <!-- 若 API_BASE 缺失，这里会显示红色告警条 -->
  <div id="topAlert" class="top-alert"></div>

  <header class="nav">
    <div class="nav-inner">
      <div class="brand">Ongao's Poker Lab</div>
      <button id="themeBtn" class="theme-toggle" type="button">☾/☀︎</button>
    </div>
  </header>

  <main class="container">
    <h1>Ongao's Poker Lab 🚀</h1>
    <p class="sub">输入手牌与公共牌，一键获取胜率，并基于 Pot Odds 给出下注建议；若后端提供 LLM 文案，则显示更详细的策略。</p>

    <!-- 轻量自检工具条 -->
    <section class="card" style="display:flex;align-items:center;gap:10px;">
      <div class="pill">API_BASE: <code id="apiBaseText">—</code></div>
      <button class="btn secondary" type="button" onclick="window.__PING_HEALTH__ && window.__PING_HEALTH__()">快速测试 /health</button>
    </section>

    <!-- 输入区 -->
    <section class="card">
      <h2>输入牌面</h2>
      <div class="row">
        <div class="stack">
          <label>手牌（2 张，格式如 <code class="inline">Ah</code>、<code class="inline">Kd</code>）</label>
          <div class="pair">
            <input id="hole1" class="input-mini" maxlength="2" placeholder="如 Ah">
            <input id="hole2" class="input-mini" maxlength="2" placeholder="如 Kd">
          </div>
          <div class="help-row">
            <div id="hero_preview" class="help-preview"></div>
            <div id="hero_error" class="help-error"></div>
          </div>
        </div>

        <div class="stack" style="flex: 2 1 360px;">
          <label>公共牌（0–5 张，任意阶段输入即可）</label>
          <div class="row">
            <input id="b1" class="input-mini" maxlength="2" placeholder="翻牌1">
            <input id="b2" class="input-mini" maxlength="2" placeholder="翻牌2">
            <input id="b3" class="input-mini" maxlength="2" placeholder="翻牌3">
            <input id="b4" class="input-mini" maxlength="2" placeholder="转牌">
            <input id="b5" class="input-mini" maxlength="2" placeholder="河牌">
          </div>
          <div class="help-row">
            <div id="board_preview" class="help-preview"></div>
            <div id="board_error" class="help-error"></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="stack">
          <label>彩池大小（可选，单位同下注）</label>
          <input id="pot" class="input-mini" type="number" min="0" step="0.01" placeholder="如 10">
        </div>
        <div class="stack">
          <label>你需要跟注的金额（可选）</label>
          <input id="call" class="input-mini" type="number" min="0" step="0.01" placeholder="如 3">
        </div>
        <div class="stack">
          <label>&nbsp;</label>
          <div class="inline">
            <button id="btn-run" class="btn" type="button">计算胜率</button>
            <button id="btn-reset" class="btn secondary" type="button">重置</button>
            <button id="btn-sample" className="btn secondary" type="button">示例填充</button>
          </div>
        </div>
      </div>
      <div id="dup-alert" class="alert alert-danger mt-2"></div>
      <p class="help">牌面格式：<code class="inline">2-9,T,J,Q,K,A</code> + <code class="inline">s/h/d/c</code>（♠/♥/♦/♣）。例如：<code class="inline">As</code>、<code class="inline">Th</code>、<code class="inline">7d</code>、<code class="inline">9c</code>。</p>
    </section>

    <!-- 实时进度（SSE） -->
    <section id="progressPanel" class="progress-card">
      <div class="progress-title">
        <div><b id="stageText">准备中…</b></div>
        <div class="progress-sub"><span id="etaText"></span></div>
      </div>
      <div class="bar-wrap x">
        <div id="bar" class="bar x"></div>
      </div>
      <div class="progress-sub" style="margin-top:6px;">
        <span id="pctText">0%</span>
        <span id="streetText" class="ms-3"></span>
      </div>
    </section>

    <!-- 结果区 -->
    <section class="card">
      <h2>胜率（Equity）</h2>
      <div class="kvs">
        <div class="muted">我方获胜概率</div>
        <div><strong id="equity-text">—</strong></div>
      </div>
      <div class="bar-wrap" style="margin:10px 0;">
        <div id="equity-bar" class="bar"></div>
      </div>
      <div class="kvs">
        <div class="muted">平局概率</div><div id="tie-text">—</div>
        <div class="muted">失败概率</div><div id="lose-text">—</div>
      </div>
    </section>

    <section class="card">
      <h2>策略建议</h2>
      <div class="kvs" style="margin-bottom:8px;">
        <div class="muted">Pot Odds（自动算）</div>
        <div id="odds-text">—</div>
      </div>
      <div id="advice" class="output">// 这里将显示来自后端的 LLM 建议；如无，则根据 equity 与 pot odds 给出兜底建议。</div>
      <div class="help" style="margin-top:8px">
        兜底规则：当 <code class="inline">equity ≥ pot_odds</code> 值得跟注；优势较大且对手弃牌率可观时可加注（建议下注量：彩池的 40%–70%）。
      </div>
    </section>

    <footer class="muted" style="margin-top:16px;">
      <small>后端 API 通过 <code>window.API_BASE</code> 指定；计算流程：<code>POST /start</code> → <code>EventSource /stream/&lt;task_id&gt;</code>。</small>
    </footer>
  </main>

  <!-- 1) 必须：先加载后端域名配置 -->
  <script src="./config.js"></script>

  <!-- 1.1 防呆：若没设置 API_BASE，给出告警 -->
  <script>
    (function(){
      const base = (window.API_BASE || '').trim();
      const warn = document.getElementById('topAlert');
      const pill = document.getElementById('apiBaseText');
      if (pill) pill.textContent = base || '（未设置）';
      if (!base) {
        warn.style.display = 'block';
        warn.textContent = '⚠️ 未检测到 API_BASE，请先在 config.js 设置后端域名（如 https://poker-assistant.onrender.com）。';
      }
      // 提供一个 /health 快速自检，不依赖 app.js
      window.__PING_HEALTH__ = async function(){
        const b = (window.API_BASE || '').replace(/\/+$/,'');
        if (!b) return alert('API_BASE 未设置！请先在 config.js 配置。');
        try{
          const r = await fetch(`${b}/health`);
          const t = await r.text();
          alert(r.ok ? `✅ /health 正常：\n${t}` : `❌ /health 响应异常：${r.status} ${r.statusText}\n${t}`);
        }catch(e){ alert('❌ /health 网络错误：' + e); }
      };
    })();
  </script>

  <!-- 2) 你的主逻辑（会使用 window.API_BASE 请求 /start 与 /stream） -->
  <script src="./app.js" defer></script>

  <!-- 3) 主题切换 -->
  <script>
    (function(){
      const html = document.documentElement;
      const btn = document.getElementById('themeBtn');
      const set = m => { html.classList.toggle('light', m==='light'); localStorage.setItem('theme', m); }
      const current = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      set(current);
      btn && (btn.onclick = () => set(html.classList.contains('light') ? 'dark' : 'light'));
    })();
  </script>

  <!-- 4) 前端实时校验（你原有逻辑，未改动） -->
  <script>
  /* 你的校验脚本（原样保留） —— 为节省篇幅，这里略。把你发来的那段原样放回这里即可 */
  </script>
</body>
</html>
